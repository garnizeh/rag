# Task 0009: Develop context update logic and validation

## Phase
Phase 2: Core Processing (Weeks 3-4)

## Description
Implement the logic for updating engineer context based on AI inference results, including validation and conflict resolution.

## Acceptance Criteria
- [ ] Parse AI inference results and update engineer context
- [ ] Implement context validation and consistency checks
- [ ] Add logic for merging new entities with existing context
- [ ] Create context change detection and tracking
- [ ] Implement conflict resolution strategies
- [ ] Add context history and versioning
- [ ] Create context rollback capabilities
- [ ] Add context update notifications

## Current status (updated)
- Parse AI inference results and update engineer context — Done
	- Implemented pure merging logic that accepts an `AIResponse` and merges entities and summary into an existing JSON context (`internal/ai/context.go`).
	- Implemented `internal/ai/processor.go` which calls the merge logic, persists merged context, records detailed history entries, and creates clarification questions for conflicts.
- Implement context validation and consistency checks — Done (basic)
	- Simple validation for entity names (`ValidateName`) and conflict detection when types mismatch (e.g., existing non-list where a list is expected).
- Add logic for merging new entities with existing context — Done
	- `MergeAIResponse` merges `people`, `projects`, and `technologies` and avoids duplicates.
- Create context change detection and tracking — Done (library + persistence)
	- Merge returns `ChangeRecord` items and `DiffContexts` computes diffs.
	- Added DB migration and persistence: `db/migrations/0004_contexts_history.sql` (creates `engineer_contexts` and `engineer_context_history`).
	- Implemented repository methods in `pkg/repository` and SQLite implementation under `internal/repository/sqlite/context.go`: `UpsertEngineerContext`, `GetEngineerContext`, `CreateContextHistory`, `ListContextHistory`, `GetContextHistoryByID`.
- Implement conflict resolution strategies — Partially Done
	- Conflicts are detected by merge. The processor creates clarification questions (via `repo.Question.CreateQuestion`) for conflicts. Automated auto-apply policies (confidence thresholds, rules) are left as next steps.
- Add context history and versioning — Done
	- `UpsertEngineerContext` performs an atomic upsert and records a history entry; `CreateContextHistory` stores richer change/conflict details.
- Create context rollback capabilities — Done (API + handler)
	- Implemented `AIHandler.RollbackContextHandler` and registered the endpoint `POST /v1/ai/context/rollback/{engineer_id}` in `api/routes.go`.
	- Rollback applies a selected history snapshot via `GetContextHistoryByID` + `UpsertEngineerContext` with `applied_by = "rollback"` and returns the new applied version.
- Add context update notifications — Deferred
	- Notifications/eventing remain a follow-up (no event bus implemented yet).

## Dependencies
- Task 0007 (AI inference engine)
- Task 0005 (Data models)

## Estimated Effort
4-5 days

## Technical Notes
- Implement proper JSON handling for context fields
- Add validation for entity names and relationships
- Use atomic database transactions for context updates
- Implement conflict detection algorithms
- Add proper error handling for malformed context data
- Consider context diff tracking for audit purposes
- Implement proper locking for concurrent updates

## Implementation details
- Files added / modified:
	- `internal/ai/context.go` — pure utilities: ContextModel, MergeAIResponse, ValidateName, DiffContexts, ChangeRecord and MergeResult types.
	- `internal/ai/context_test.go` — unit tests covering merge and diff logic.
	- `db/migrations/0004_contexts_history.sql` — migration to add `engineer_contexts` and `engineer_context_history` tables.
	- `pkg/repository/repository.go` — added `ContextRepo` interface and `Context` field on `Repository`.
	- `internal/models/models.go` — added `ContextHistory` model.
	- `internal/repository/sqlite/context.go` — sqlite implementations for context persistence and history.
	- `internal/ai/processor.go` — orchestrates merging, persistence, history creation, and question creation for conflicts.
	- `api/ai.go` — added `RollbackContextHandler` and wiring to `ContextRepo`.
	- `api/routes.go` — registered `POST /v1/ai/context/rollback/{engineer_id}` route.
	- `cmd/server/main.go` — worker wiring: registered `ai.process_response` handler and started WorkerPool so AI jobs are processed in background.
	- `internal/jobs/ai_integration_test.go` — integration test that enqueues an AI job and verifies context persistence.

- Behavior summary:
	- MergeAIResponse(existingJSON, resp) parses existing JSON, validates entity names, merges lists without duplicating values, merges summary (replaces if changed), and records a small `_meta` block with `last_ai_update` and `context_update_intent`.
	- When a merge finds a type mismatch (for example, an existing non-list for `projects`) it records a conflict entry instead of overriding silently.
	- The function is intentionally pure and does not write to DB; callers (worker/job handlers or API) should wrap persistence in an atomic transaction and record history using `DiffContexts`/ChangeRecord.

## Tests & verification
- Unit tests:
	- `internal/ai/context_test.go` covers merge/diff behavior.
	- `api/ai_test.go` includes `TestRollbackHandler` for the rollback handler.
- Integration tests:
	- `internal/jobs/ai_integration_test.go` enqueues an `ai.process_response` job and verifies the worker processed it and the context was persisted.
	- Ran targeted tests and integration test locally (`go test ./api` and `go test ./internal/jobs -run TestAIProcessJobIntegration`) — passing.

## Next steps (recommended)
1. Conflict resolution policies
	- Implement configurable auto-apply policies (e.g., min-confidence threshold) and policy-driven merges.
2. Notifications & events
	- Hook a lightweight event publisher (webhooks or message bus) to emit context-update events for downstream consumers.
3. Authorization & audit
	- Add ACL checks to the rollback endpoint and record who performed rollbacks in history metadata.
4. More tests
	- Add integration tests for conflict-question flows and retries, and concurrency tests for simultaneous AI updates.
5. Documentation
	- Document the `ai.process_response` job payload and create a short README for operating the worker.

## Definition of Done mapping
- Context updates work reliably based on AI results — Done (merge logic + processor + persistence via `ContextRepo` implemented)
- Validation prevents invalid context states — Partially Done (basic name validation implemented)
- Conflict resolution handles edge cases — Partially Done (detection + question creation implemented; policy automation pending)
- Context history is maintained — Done (DB migration + history writes implemented)
- Update notifications are sent appropriately — Deferred
- Rollback functionality is available when needed — Done (API + handler implemented)

If you want, I can proceed to wire the merging logic into the job/worker that processes AI responses and implement DB history + transactional update in the same change. Otherwise I can create separate follow-up tasks for each next-step and implement them one at a time.

## Definition of Done
- Context updates work reliably based on AI results
- Validation prevents invalid context states
- Conflict resolution handles edge cases
- Context history is maintained
- Update notifications are sent appropriately
- Rollback functionality is available when needed
