## RAG Fixes and Improvements — fix-0002

This document lists follow-up tasks (delta after fix-0001) ordered by priority (highest first). Each task includes a short description, acceptance criteria, and an estimated effort so maintainers can pick work items easily.

### How to use
- Pick the top-most item to make the biggest impact.
- Every task is small and testable. Where applicable I include a short contract (inputs/outputs/error modes) and 1–2 edge cases to cover in tests.

---

## Priority A — High

1) Wire opt-in migrate_on_start in `cmd/server`

- What: Read `cfg.MigrateOnStart` (or `migrate_on_start`) and call `internal/db.Migrate(ctx, cfg.DatabasePath)` before binding the HTTP listener. Log actions and fail startup on migration errors.
- Acceptance criteria:
  - When `migrate_on_start: true` the server runs migrations and exits non-zero on failure.
  - Migrations are idempotent and recorded in `schema_migrations`.
  - Unit/integration test that runs server startup path against a temporary sqlite file and asserts migrations were applied.
- Contract: Input: ctx, database path, logger. Output: nil or error. Errors: file permissions, SQL error, migration conflict.
- Estimate: 1–2 hours.

2) Ensure `pkg/ollama.Generate` mapping and callers are consistent

- What: Verify `Generate` returns the typed `GenerateResult { Text, Raw, Meta }` everywhere. Update any stray call sites and add a small unit test that exercises mapping (including `Meta.latency_ms` and `Meta.model`).
- Acceptance criteria:
  - No remaining callers expect the old string-format output.
  - Unit tests cover happy path and a simulated timeout/retry behavior.
- Contract: Input: ctx, prompt, options. Output: GenerateResult or error.
- Estimate: 1–3 hours.

3) Propagate `*slog.Logger` via constructors (DB & repository)

- What: Refactor `internal/db` and `repository/sqlite` constructors to accept `*slog.Logger` instead of package-level SetLogger where used. Update call sites (main) to pass the logger.
- Acceptance criteria:
  - No package-level logger globals in `internal/db` or `repository/sqlite`.
  - Tests still pass and logs emitted by db/repo include structured fields (e.g., migration, query errors).
- Edge cases: preserve backward-compatibility for any external package using the old constructors (search repository first).
- Estimate: 1–2 hours.

---

## Priority B — Medium

4) Add an httptest-based integration for `pkg/ollama` or accept an HTTP client

- What: Add a unit/integration test using `httptest.Server` that simulates Ollama responses and verifies `pkg/ollama.Generate` behavior (parsing, metadata, error handling), or refactor `pkg/ollama` to accept an `http.Client`/transport for easy mocking.
- Acceptance criteria:
  - Tests cover normal response, malformed JSON, and non-200 responses.
  - `pkg/ollama` code supports injection of the HTTP transport for tests.
- Estimate: 1–3 hours.

5) Add migration + Ollama startup smoke tests in CI

- What: Add focused CI jobs (or `make` tasks) that run:
  - Migration runner against a temp DB
  - `pkg/ollama` httptest
  - Server startup with `migrate_on_start` enabled (non-networking; use temp DB and mocked Ollama)
- Acceptance criteria: CI runs these and fails on regressions.
- Estimate: 2–4 hours (depends on CI config)


---

## Priority C — Low / Nice-to-have

6) Expand `configs/dev.yaml` and `README.md` with examples

- What: Add examples for durations/timeouts and a full `ollama` block.
- Acceptance criteria: `configs/dev.yaml` demonstrates `timeout: "30s"`, `token_duration: "1h"`, and `ollama: { base_url, timeout, model }`. README updated with usage notes.
- Estimate: 30–60 minutes.

7) Add metrics for AI availability and migration events

- What: Expose Prometheus counters/gauges for: `ai_available` (gauge 0/1), `migrations_applied_total` (counter), and `migration_last_failed` (gauge + log). Instrument transition events in the Ollama probe and migration runner.
- Acceptance criteria: Metrics exposed on the metrics endpoint and unit-tested where possible (metric value changes on simulated transitions).
- Estimate: 2–4 hours.

8) Add `Close()` / resource cleanup to `pkg/ollama` client if needed

- What: If the Ollama client holds resources that require explicit teardown (channels, pooled connections, background goroutines), add `Close() error` and call it in the probe when swapping clients.
- Acceptance criteria: no goroutine leaks when creating/swapping clients repeatedly (run a short leak-check test).
- Estimate: 1–2 hours.

---

## Cross-cutting tests & quality gates

- Always run: `gofmt -w . && go test ./...` after changes.
- New integration tests should be fast and use `httptest` or temporary sqlite files.
- Provide clear logging messages on migrations and AI availability transitions.

## Quick next-step recommendation

- Implement item 1 (migrate_on_start wiring) first. After that, implement item 2 (ollama mapping verification) and item 3 (logger DI) in that order.

---

Document author: automated follow-up
Date: 2025-08-24
