## RAG Fixes and Improvements — fix-0001

This document lists the recommended fixes, rationale, priority, and implementation notes for issues discovered during a code review focused on application startup and configuration (Ollama integration, DB, config validation, and secure defaults).

NOTE: This document has grown large — new follow-up tasks have been moved into a companion document at `.docs/fix-0002.md` which contains a prioritized, actionable list of smaller work items. Use `fix-0002.md` for bite-sized tasks and `fix-0001.md` for the overall context and implemented changes.

Keep all changes small and safe; prefer fail-fast behavior for misconfiguration in production and allow more permissive defaults for local development.

### Summary checklist

- [x] Include `OllamaConfig` in the main `Config` and load it from YAML/env — implemented (defaults populated)
- [x] Validate configuration at startup (`Config.Validate()`) — implemented and called in `main`
- [x] Reject insecure JWT secret defaults in non-development environments — implemented (Validate fails)
- [x] Perform dependency health checks (DB ping, Ollama.Health) before accepting traffic — implemented (Ollama.Health check added; DB ping via `db.New`)
- [x] Run or verify DB migrations on startup (or fail fast and instruct operator) — implemented as opt-in `migrate_on_start` in config
- [ ] Use structured logger and inject logger into subsystems (optional, recommended)
- [x] Avoid variable names that shadow package names (e.g. `db` var vs `db` package) — addressed in `cmd/server/main.go`
- [ ] Document expected YAML formats (durations, timeouts, model names) in `configs/` and README
- [ ] Improve `pkg/ollama` Generate return shape and error handling
- [ ] Add readiness and liveness endpoints (or ensure `/health` and `/version` reflect readiness)
- [x] Add readiness endpoint (`/ready`) that reports DB + AI status; liveness endpoint (`/live`) still TODO
- [x] Remove prompt/template from config and manage templates exclusively in DB — implemented (config now has `engine.template_version` only)

### Priorities

- High: Config validation, Ollama config exposure, secure JWT handling, dependency healthchecks, migrations
- Medium: Structured logging, clear YAML examples, variable shadowing fixes
- Low: API response shaping for Ollama, cosmetic improvements

---

### 1) Expose Ollama configuration through main `Config`

Problem
- The project defines an `OllamaConfig` type but does not include it inside the top-level `Config` used by `cmd/server/main.go`. The code uses a hard-coded `DefaultConfig()` in `pkg/ollama`, preventing operators from configuring base URL, model names, timeouts, or retries via YAML or environment variables.

Impact
- Inflexible deployments and difficulty adapting to different Ollama ports/instances or testing with alternate models. Ops cannot tune retries/timeouts for production.

Change
- Add a field `Ollama config.OllamaConfig `yaml:"ollama"` to `internal/config.Config` and populate reasonable defaults (can reuse `pkg/ollama.DefaultConfig()` defaults). When `LoadConfig` decodes YAML, it should overwrite only provided fields.

Files to change
- `internal/config/config.go` (add field and defaults)
- `cmd/server/main.go` (use `cfg.Ollama` when creating the client)

Testing
- Unit test that loads `configs/dev.yaml` with an `ollama` section and verifies values are applied. Integration: start server pointing to a test Ollama instance.

Notes
- Keep backwards-compatible behavior: if `cfg.Ollama.BaseURL` is empty, fallback to `pkg/ollama.DefaultConfig()`.

---

### 2) Add `Config.Validate()` and do fail-fast validation in `main`

Problem
- `LoadConfig` returns a config struct but no validation is performed. Missing or invalid values will surface later as runtime errors.

Impact
- Surprising runtime failures; uncertain startup state.

Change
- Implement `func (c *Config) Validate() error` in `internal/config` to check:
  - `Addr` is parseable (non-empty)
  - `APITimeout` > 0
  - `DatabasePath` non-empty
  - `TokenDuration` > 0
  - `EngineConfig.Model` non-empty (if AI features required)
  - `Ollama.BaseURL` either set or explicit fallback
  - `JWTSecret` is non-empty and not the insecure default (see next item)

- Call `cfg.Validate()` immediately after `LoadConfig` in `cmd/server/main.go` and `log.Fatal` on error.

Files to change
- `internal/config/config.go`, `cmd/server/main.go`

Testing
- Unit tests for `Validate()` covering missing or invalid fields.

---

### 3) Reject insecure JWT secret defaults in production

Problem
- Default `JWTSecret` is `supersecretkey` in `LoadConfig`, which is insecure.

Impact
- If operators forget to set a strong secret, tokens are vulnerable.

Change
- Make `Validate()` fail if `JWTSecret` is empty or equals the insecure default unless a `development` flag/env is set. Prefer requiring `RAG_JWT_SECRET` in environments other than local/dev. Document behavior in README and `configs/dev.yaml`.

Testing
- Unit tests that assert validation fails for default secret and passes when a strong secret is provided.

---

### 4) Perform dependency health checks before binding to address

Problem
- The server starts ListenAndServe without checking DB or Ollama reachability.

Impact
- Server reports it is up but core subsystems are unusable, causing failed requests and poor operator experience.

Change
- After successful DB open and after creating the Ollama client, perform:
  - `db.PingContext(ctx)` (already performed by `db.New`) or an explicit quick check
  - `ollamaClient.Health(ctx)` (call and treat failure per policy)

- Decide policy: fail fast (recommended for production) or mark AI routes as degraded (documented). If fail-fast, call `log.Fatalf` and stop startup.

Files to change
- `cmd/server/main.go`, possibly `pkg/ollama/client.go` if Health signature needs adjustment.

Testing
- Integration test that simulates Ollama down and asserts server refuses to start (or starts in degraded mode depending on chosen policy).

---

### 5) Verify or execute DB migrations during startup

Problem
- There are DB migration scripts in `db/migrations/` and scripts to initialize the DB, but `cmd/server` does not perform migrations.

Impact
- Operators must remember to run migrations; mismatch between binary and schema may cause runtime errors.

Change
- Add an explicit check in startup that verifies the schema version or runs migrations automatically (make this opt-in via config flag `migrate_on_start: true`). If opting to auto-run, log actions and fail on migration error.

Files to change
- `cmd/server/main.go`, add small migration runner (or reuse `scripts/db_init` logic as a package)

Notes
- A migration runner was added in `internal/db/migrate.go` and both `scripts/db_init` and `cmd/server` now call it (opt-in via `migrate_on_start`). Seeds were moved to `db/seed/` and are applied by the migration runner.

Testing
- Integration test that uses a temp DB, runs server with `migrate_on_start: true`, and asserts migrations applied.

---

### 6) Improve `pkg/ollama.Generate` return shape and error handling

Problem
- `Generate` returns a string created with `fmt.Sprintf("%+v", r)` on `api.GenerateResponse`, which is not a clean payload for callers.

Impact
- Downstream code must parse formatted strings; loss of typed data and fields.

Change
- Return a typed struct, for example `type GenerateResult struct { Text string; Raw json.RawMessage; Meta map[string]any }`, or return the `api.GenerateResponse` as-is if stable. Provide helper methods to extract text.

Files to change
- `pkg/ollama/client.go` and call sites in `internal/ai`.

Testing
- Unit tests for `Generate` mapping and for retry/backoff behavior.

---

### 7) Logging and variable shadowing

Problem
- `main` uses `log.Printf` (plain stdlib) and variable name `db` shadows package `db` in imports; this can confuse maintainers.

Change
- Use a structured logger (`slog` or `zap`) to produce leveled logs and include request IDs. Inject logger into subsystems where helpful.
- Rename local DB variable to `database` or `dbConn` to avoid shadowing.

Files to change
- `cmd/server/main.go`, and optionally other entry points and packages.

---

### 8) Configuration file examples and docs

Problem
- `configs/dev.yaml` is minimal and does not demonstrate `time.Duration` formats or `ollama` configuration.

Change
- Expand `configs/dev.yaml` with examples like:
  ```yaml
  addr: ":8080"
  jwt_secret: "your_jwt_secret_key"
  database_path: "rag.db"
  timeout: "15s"
  token_duration: "1h"
  ollama:
    base_url: "http://localhost:11434"
    models: ["deepseek-r1:1.5b"]
    timeout: "30s"
  ```

Files to change
- `configs/dev.yaml`, `README.md` (configuration section)

---

### 9) Readiness and liveness

Problem
- There are `/health` and `/version` endpoints but no clear separation between liveness and readiness (i.e., readiness should fail if dependencies are unhealthy).

Change
- Make `/health` return readiness state (check DB and Ollama) and add `/live` for liveness only (process alive). Or document current semantics and ensure orchestration uses the right endpoint.

Files to change
- `api/system.go` (or wherever handlers are implemented)

---

### Implementation plan (small, safe steps)

1. Add `Ollama` field to `internal/config.Config` and load defaults. (small)
2. Implement `Config.Validate()` and call it from `cmd/server/main.go`. (small)
3. Make `cmd/server` call `ollamaClient.Health()` after client construction and before ListenAndServe; decide fail-fast/degraded policy. (small)
4. Add `migrate_on_start` config flag and wire a migration verification/run; centralize migrations+seeds in `internal/db.Migrate`. (medium)
5. Remove prompt/template text from config and use DB templates only; add a `engine.template_version` config field to select default template at startup. (small)
5. Improve `pkg/ollama.Generate` signature to return a typed result. (medium)
6. Update `configs/dev.yaml` and README examples. (small)

Each change should include a unit test (where applicable) and an integration smoke test demonstrating startup success/failure modes.

### Validation checklist (quality gates)

- go build ./... -> PASS
- go vet ./... -> PASS
- Unit tests for new validation/migration code -> PASS
- Manual run with `configs/dev.yaml` -> server binds and reports readiness when dependencies available

---

Implemented items (this run):

- Include `OllamaConfig` in `Config` and default population — Done
- `Config.Validate()` with sensible defaults and security checks — Done
- Reject insecure JWT secret in non-development — Done (Validate fails)
- Create Ollama client using `cfg.Ollama` and run `client.Health()` at boot — Done (fail-fast behavior)

Note: Ollama policy changed in this run — the server now tolerates Ollama being down at startup.
If the Ollama client cannot be created or the health check fails, the server logs a warning and
continues in degraded mode (AI features disabled). This preserves the ability to accept raw
entries while Ollama is unavailable.

Validation status:

- go build ./... -> PASS
- go test ./... -run Test -count=1 -> PASS (package tests run; see CI output)

Additional implemented items (this run):

- Templates removed from config; config now contains only `engine.template_version` and templates are loaded from DB at engine initialization. — Done
- Migration runner `internal/db.Migrate` added and seed files placed in `db/seed/`; `scripts/db_init` and `cmd/server` use the runner. — Done

Additional implemented items (this session):

- Server tolerates Ollama failure at startup (degraded mode) — Done
- Readiness endpoint `/ready` added (reports DB ok / AI degraded) — Done
- Unit tests updated: `api/system_test.go` now covers readiness scenarios — Done

Validation status (this session):

- go build ./... -> PASS
- go test ./api -> PASS (api package tests including readiness) 

Next recommended steps (not yet implemented):

- Run/verify DB migrations during startup (opt-in `migrate_on_start`)
- Improve `pkg/ollama.Generate` return shape
- Replace stdlib logging with structured logger and inject logger
- Add readiness/liveness endpoints separation

Next recommended step: implement a small background probe that periodically checks Ollama and
updates engine availability (or flip AI to available) so the service can recover without restart.

Recent changes (auto-recovery and engine availability)

- Added thread-safe engine client updates: `Engine.SetClient(*ollama.Client)` and `Engine.Available()` — callers can now detect degraded mode programmatically.
- `AnalyzeActivity` now uses a read-lock when accessing the client so the probe can swap the client concurrently.
- Background Ollama probe added to `cmd/server/main.go`: periodically attempts to create and health-check a client and updates the engine when successful; on failure it keeps the engine in degraded mode. The probe interval uses `cfg.Ollama.Backoff` and timeouts use `cfg.Ollama.Timeout`.
- This enables automatic recovery when Ollama becomes available again without restarting the server.

Validation status (auto-recovery)

- go build ./... -> PASS (after adding probe and engine availability methods)

Notes

- The probe currently creates a new client on each attempt; if the Ollama client requires explicit teardown we should extend the client API to Close resources and ensure the probe calls it.
- Next minor improvement: expose AI availability via metrics and emit logs/metrics on transition events.

If you'd like I will implement the DB migration runner next and add unit tests for `Validate()` edge cases. I will proceed to add tests for `Validate()` now.

---

Document author: Automated code review
Date: 2025-08-24

## Follow-up work (this edit)

This section breaks remaining work into small, concrete tasks with acceptance criteria so maintainers can pick them up one-by-one.

Short checklist (small, testable tasks)

- [ ] Add opt-in `migrate_on_start` wiring in `cmd/server/main.go` and call `internal/db.Migrate(ctx, path)` when enabled. (See contract below)
- [ ] Improve `pkg/ollama.Generate` return type to a typed `GenerateResult` and update callers in `internal/ai` to use the new shape.
- [ ] Introduce a structured logger (recommended: `slog`) in `cmd/server` and pass logger to subsystems; rename local `db` variables to avoid shadowing.
- [ ] Split readiness and liveness: make `/health` reflect readiness (DB + Ollama checks) and add `/live` for process liveness only.
- [ ] Expand `configs/dev.yaml` and `README.md` with examples for durations, timeouts, and `ollama` config.
- [ ] Add unit tests for `Config.Validate()` edge cases and a small integration smoke test for `migrate_on_start`.

---

### Recent edits (delta since last save)

These items were implemented in the codebase during the last edit cycle and verified with unit tests.

- [x] Structured logging: replaced stdlib logging with structured `slog` and injected it into HTTP routing and middleware. `cmd/server` creates a `slog` logger and passes it into `api.SetupRoutes(...)`. The `api` package exposes `SetLogger` so middleware and helpers use the injected logger. `internal/ai` exposes `SetLogger` as well and uses `slog` for AI-related logs.
- [x] `pkg/ollama.Generate` refactor: `Generate` returns a typed `GenerateResult { Text, Raw, Meta }` (already implemented earlier) so downstream code uses the structured result instead of formatted strings.
- [x] Readiness/Liveness split: added `/ready` (readiness) and `/live` (liveness) endpoints. `ReadinessHandler` checks DB and reports AI as degraded; `LiveHandler` is a simple liveness probe (HTTP 200) for process aliveness.
- [x] `internal/config.Validate()` unit tests: added tests covering insecure JWT default behavior, missing engine model, and Ollama default population.
- [x] Test package hygiene: updated test files to use external test packages (package name suffix `_test`) where appropriate and adjusted imports (notably `internal/config`, `internal/db/migrate_test`, `pkg/ollama/client_test`).

Validation & verification

- Ran `go test ./...` locally: full test suite passed after these edits.
- `go build ./...` remained green during the edits.

Notes & small follow-ups

- The `slog` usage currently employs a human-friendly TextHandler in dev; switching to JSON handler for production logs is a trivial change in `cmd/server/main.go`.
- `api.SetupRoutes` signature was extended to accept a `*slog.Logger` — update any external callers if added in future.
- Next recommended items: add metrics for AI availability/transitions, expand `configs/dev.yaml` docs, and add an httptest-based integration test for `pkg/ollama` (or refactor to an interface to easily mock the HTTP transport).

Contracts (input / output / error modes)

- Migrate-on-start runner
  - Input: context.Context, path to sqlite DB (string), logger (optional)
  - Output: error (nil on success)
  - Errors: migration failure, file permissions, lock contention
  - Success criteria: migrations applied idempotently and schema version recorded

- Ollama.Generate refactor
  - Input: ctx, prompt, options
  - Output: GenerateResult { Text string; Raw json.RawMessage; Meta map[string]any }
  - Errors: network, timeout, unmarshalling

- Config.Validate
  - Input: loaded Config
  - Output: nil or descriptive validation error
  - Edge/guard rails: clear messaging for insecure JWT secret, missing DB path, non-positive durations

Edge cases to cover in tests

- Missing or empty `database_path` in YAML
- JWT secret equal to insecure default and environment set to `production`
- Ollama unreachable during health check (ensure policy: fail-fast)
- Migration partially-applied / interrupted migration

Files to change (suggested minimal list)

- `cmd/server/main.go` — wire `migrate_on_start`, logger, rename local vars, call `cfg.Validate()` (if not already)
- `internal/db/migrate.go` — ensure exported `Migrate(ctx, dbPath string) error` and idempotent behavior
- `pkg/ollama/client.go` — change `Generate` signature and return type; add unit tests
- `api/system.go` or `api/system_test.go` — add `/live` handler and update `/health`
- `configs/dev.yaml`, `README.md` — examples and docs
- `internal/config/config_test.go` — unit tests for `Validate()`

Estimated effort per task

- migrate_on_start wiring: 1–2 hours (code + integration smoke test)
- `Generate` signature change: 2–4 hours (update callers + tests)
- structured logging: 1–3 hours (introduce `slog`, pass logger, update a few modules)
- readiness/liveness endpoints: 1 hour
- docs update: 30–60 minutes

Quality gates (before merge)

- go build ./... -> PASS
- go vet ./... -> PASS
- go test ./... -> PASS (new tests included)
- Manual smoke: start server with `configs/dev.yaml` and dependencies available; `/health` returns ready

Try-it notes (how to run the smoke test locally)

1. Ensure Ollama is running locally at the configured `ollama.base_url`.
2. Start the server with the dev config and migrations enabled.

Example (local):

```bash
# from repository root (bash)
export RAG_ENV=development
# run server (the Makefile has dev targets; alternatively run `go run`)
go run ./cmd/server -config configs/dev.yaml
```

Completion summary

- This edit appends prioritized, testable follow-up tasks to the `fix-0001` document and clarifies contracts, edge cases, and files to change. It does not alter code.
- Next step recommended: pick one small task (I suggest `migrate_on_start`) and I can implement it with tests and a verification run.

Document editor: Automated code review
Edited: 2025-08-24
