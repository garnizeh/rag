# Task 0004: Set up Ollama integration and model management

## Phase
Phase 1: Foundation (Weeks 1-2)

## Summary
Implemented a lightweight Ollama integration package that provides a client wrapper with retries, timeouts, a simple circuit breaker, model listing/health checks, and a small prompt templating utility.

## Acceptance Criteria (status)
- [x] Create Ollama client wrapper with proper error handling
- [x] Implement model management (list, health check) — download/pull left as CLI/tooling (see Notes)
- [x] Add configuration for different models (deepseek-r1:32b, llama3, etc.)
- [x] Implement request/response validation (HTTP status checks and error returns)
- [x] Add timeout and retry logic for AI requests
- [x] Create fallback mechanisms for service unavailability (simple circuit breaker)
- [x] Add Ollama health monitoring
- [x] Implement basic prompt templating system

## Files changed / added
- `pkg/ollama/config.go` — configuration struct and `DefaultConfig()`
- `pkg/ollama/client.go` — client wrapper: `NewClient`, `Health`, `ListModels`, `Generate`, retries/backoff, simple circuit breaker
- `pkg/ollama/templater.go` — `RenderTemplate` for basic prompt templating

## Usage (quick)
- Create client:

	cfg := ollama.DefaultConfig()
	client, err := ollama.NewClient(cfg, nil)

- Health check:

	err := client.Health(ctx)

- List models:

	models, err := client.ListModels(ctx)

- Generate text (returns a formatted string of the response):

	out, err := client.Generate(ctx, "deepseek-r1:1.5b", "List some unusual animals")

- Render a prompt template:

	prompt, err := ollama.RenderTemplate("Summarize: {{.Text}}", map[string]string{"Text":"hello"})

## Verification
- Project built successfully after changes: `go build ./...` (no compilation errors).

## Notes & assumptions
- Model "download" (pull/install) is typically performed by the `ollama` CLI (e.g., `ollama pull <model>`). This implementation focuses on programmatic generation and model listing/health. If you want programmatic pulls, I can add a wrapper that shells out to the CLI or calls any available server-side endpoints.
- The circuit breaker implemented is intentionally minimal (failure counter + open-until timestamp). It is suitable for now but can be replaced with a robust library if needed.
- `Generate` returns a formatted string representation of the `api.GenerateResponse`. If you prefer structured output, we can parse and expose fields.

## Next steps (suggested)
- Add unit tests for `templater.go` and `client.go` (happy path + failure). I can add these.
- Wire `client.Health` into the application's system health endpoint (e.g., `api/system.go`).
- Add logging/metrics for requests, retries, and circuit breaker state.
- Optionally add programmatic model pull (CLI wrapper) and caching of model metadata.

## Definition of Done (re-evaluated)
- Ollama client communicates with local instance: Done (generate via `api.NewClient` and HTTP calls)
- Model management functions (list, health): Done
- Health checking implemented: Done
- Error handling and retries: Done
- Prompt templating: Done
- Configuration supports multiple models: Done

